---
title: "Deceased donor assessment report"
subtitle: "Report date: `r as.integer(format(Sys.time(), '%m'))`/`r as.integer(format(Sys.time(), '%d'))`/`r format(Sys.time(), '%Y')`"
output:
  pdf_document: default
urlcolor: blue
fontsize: 11pt
header-includes:
  \usepackage{titling}
  \setlength{\droptitle}{-10em}
  \usepackage{caption}
  \usepackage{helvet}
  \renewcommand{\familydefault}{\sfdefault}
  \usepackage{fancyhdr}
  \pagestyle{fancy}
  \setlength{\headheight}{13.59999pt}
  \fancyhead[L]{Deceased donor assessment report}
  \fancyhead[R]{`r as.integer(format(Sys.time(), '%m'))`/`r as.integer(format(Sys.time(), '%d'))`/`r format(Sys.time(), '%Y')`}
---

\vspace{-20truemm}
\captionsetup[table]{labelformat=empty}

```{r include=FALSE}
#This is a self-contained program. All you need to do is press the "Knit" button above. It will ask you for the patient MRN and the donor ID, and then create a PDF report.

#The code below prompts RStudio to ask you for the patient's MRN, and then the donor's UNOS ID.
MRN_patient <- rstudioapi::askForPassword("Patient MRN")
First_name_donor <- rstudioapi::askForPassword("Donor ID")
```

```{r eval=FALSE, include=FALSE}
#This is test code. Turn off the code chunk above and type in the MRN and donor ID for an example report when testing new code, so you don't have to type in the data to the pop-up boxes every time. Turn this code off, and the code above on when you are ready to use the program in production.

MRN_patient <- "XXX"
First_name_donor <- "XXX"
```

```{r eval=FALSE, include=FALSE}
#These are all of the plugins that are required for this program to work. These only need to be installed once, which is why this code chunk is set to "eval=FALSE." 
install.packages("DBI")
install.packages("odbc")
install.packages("tidyverse")
install.packages("tinytex")
install.packages("lubridate")
install.packages("stringi")
install.packages("kableExtra")
tinytex::install_tinytex()
```

```{r include=FALSE}
#These are the libraries (plugins) that are required for this program to run. The first two are required to connect to the HistoTrac SQL server, "tidyverse" enables the use of more user-friendly code, "kableExtra" allows for more customizable tables on the final report, "lubridate" helps with using time and date data, and "stringi" helps put colons into typing that doesn't have colons.
library(DBI)
library(odbc)
library(tidyverse)
library(kableExtra)
library(lubridate)
library(stringi)

#Creating a connection to the HistoTrac server
con <- dbConnect(odbc::odbc(), "HistoTrac", timeout = 10)

#Connecting to the Patient table in HisoTrac, and pulling out the entry for the patient.
(Patient <- tbl(con, "Patient") 
  %>% select(PatientId, HospitalID, firstnm, lastnm, DOB, ABOCd, UNOSCPRAAmt, categoryCd: GenderCd, PatientTypeCd, A1Cd:dq2cd, mA1Cd:mDPB12cd, StatusCd, UnacceptAntigenTxt, mA1EqCd, mDPB12EqCd, UNOSUnacceptAntigenTxt)
  %>% filter(HospitalID == MRN_patient)
  %>% as_tibble
)

#Extracting the PatientId from HistoTrac, which will allow for linking to the donor
Patient_Id <- Patient$PatientId

#Connecting to the RelatedPatient table in HistoTrac
(RelatedPatient <- tbl(con, "RelatedPatient") 
  %>% select(CaseId, RelatedPatientID, RelationshipTypeCd))

#Connecting to the Patient table again, but this time to get the donor info out (donors are also stored in the Pateint table in HisoTrac)
(Donor <- tbl(con, "Patient") 
  %>% select(PatientId, HospitalID, firstnm, lastnm, DOB, ABOCd, categoryCd: GenderCd, PatientTypeCd, A1Cd:dq2cd, mA1Cd:mDPB12cd, StatusCd, UnacceptAntigenTxt, mA1EqCd, mDPB12EqCd, UNOSCPRAAmt, UNOSUnacceptAntigenTxt)
  )

#Connecting to the PatientCase table, and linking to the RelatedPatient and Donor tables to get donors
(PatientCase <- tbl(con, "PatientCase") 
  %>% select(PatientId, CaseId)
  %>% filter(PatientId == Patient_Id)
  %>% left_join(RelatedPatient, by = "CaseId")
  %>% left_join(Donor, by = c("RelatedPatientID" = "PatientId"))
  %>% as_tibble
)

#Lininking donors to the patient record, and selecting for the donor of interest
(Case <- Patient 
  %>% left_join(PatientCase, by = "PatientId", suffix = c(".recipient", ".donor"))
  %>% filter(firstnm.donor == First_name_donor)
  
  #Keep only the first row if the donor is listed more than once
  %>% slice_head(n = 1)
  
  #To ensure matching is accurate, all non-numbers or colons (:) will be removed from typing fields (e.g. remove asterisks, or G or P group designations). "N" for null alleles are kept.
  %>% mutate(across(A1Cd.recipient:mDPB12cd.recipient, ~str_extract(., "[[:digit:]:Nn]+")))
  %>% mutate(across(A1Cd.donor:mDPB12cd.donor, ~str_extract(., "[[:digit:]:Nn]+")))
  
  #For Cw typing, make sure only numbers are recorded, without leading zeros.
  %>% mutate(Cw1Cd.recipient = as.character(as.integer(str_extract(Cw1Cd.recipient, "[:digit:]+"))))
  %>% mutate(Cw2Cd.recipient = as.character(as.integer(str_extract(Cw2Cd.recipient, "[:digit:]+"))))
  %>% mutate(Cw1Cd.donor = as.character(as.integer(str_extract(Cw1Cd.donor, "[:digit:]+"))))
  %>% mutate(Cw2Cd.donor = as.character(as.integer(str_extract(Cw2Cd.donor, "[:digit:]+"))))
  
  #For low res DPB1 typing, I will convert it all to a new serologic equivalent, which will just be the first field, without any leading zeros. This will align best with the SAB specificities.
  %>% mutate(DP1Cd.recipient = as.character(as.integer(str_extract(mDPB11cd.recipient, "[:digit:]+"))), .after = dq2cd.recipient)
  %>% mutate(DP2Cd.recipient = as.character(as.integer(str_extract(mDPB12cd.recipient, "[:digit:]+"))), .after = DP1Cd.recipient)
    %>% mutate(DP1Cd.donor = as.character(as.integer(str_extract(mDPB11cd.donor, "[:digit:]+"))), .after = dq2cd.donor)
  %>% mutate(DP2Cd.donor = as.character(as.integer(str_extract(mDPB12cd.donor, "[:digit:]+"))), .after = DP1Cd.donor)
  
  #For DQA1 and DPA1 typing, I will create a low-res version of just the first field to enable matching and DSA determination
  %>% mutate(DQA1.1.LR.recipient = as.character(str_extract(mDQA11Cd.recipient, "[:digit:]+")), .after = mDQA12Cd.recipient)
  %>% mutate(DQA1.2.LR.recipient = as.character(str_extract(mDQA12Cd.recipient, "[:digit:]+")), .after = DQA1.1.LR.recipient)
  %>% mutate(DQA1.1.LR.donor = as.character(str_extract(mDQA11Cd.donor, "[:digit:]+")), .after = mDQA12Cd.donor)
  %>% mutate(DQA1.2.LR.donor = as.character(str_extract(mDQA12Cd.donor, "[:digit:]+")), .after = DQA1.1.LR.donor)
  
  %>% mutate(DPA1.1.LR.recipient = as.character(str_extract(mDPA11Cd.recipient, "[:digit:]+")), .after = mDPA12Cd.recipient)
  %>% mutate(DPA1.2.LR.recipient = as.character(str_extract(mDPA12Cd.recipient, "[:digit:]+")), .after = DPA1.1.LR.recipient)
  %>% mutate(DPA1.1.LR.donor = as.character(str_extract(mDPA11Cd.donor, "[:digit:]+")), .after = mDPA12Cd.donor)
  %>% mutate(DPA1.2.LR.donor = as.character(str_extract(mDPA12Cd.donor, "[:digit:]+")), .after = DPA1.1.LR.donor)
  )

#Connecting to the PatientCase table, and linking to the RelatedPatient and Donor tables to get donors.
(Notes <- tbl(con, "ActivationHistory") 
  %>% select(PatientId, TxnCd, NotesTxt)
  %>% filter(PatientId == Patient_Id)
  %>% filter(TxnCd == "SPECIAL_XM")
  %>% select(NotesTxt)
  %>% as_tibble
)

#Connecting to the TransplantHistory table to get sensitizing events history.
(TransplantHistory <- tbl(con, "TransplantHistory") 
  %>% select(PatientId, TransplantDt, EventCd, DonorId, DonorHlaCD, NotesTxt, OrganCd)
  %>% filter(PatientId == Patient_Id)
  %>% as_tibble
  %>% mutate(NotesTxt = str_replace(NotesTxt, "\r\n", ", "))
  #%>% mutate(DonorId = na_if(DonorId, ""))
  %>% mutate(DonorId = case_when(str_detect(DonorId, "[:alnum:]") ~ str_glue("Donor: {DonorId}"), TRUE ~ ""))
  %>% mutate(DonorHlaCD = case_when(str_detect(DonorHlaCD, "[:alnum:]") ~ str_glue("Donor typing: {DonorHlaCD}"), TRUE ~ ""))
  %>% mutate(Notes = str_glue("{OrganCd} {DonorId} {DonorHlaCD} {NotesTxt}"))
  %>% select(TransplantDt, EventCd, Notes)
)
```

```{r include=FALSE}
#Determine mismatches between recipient and donor

#Determine mismatched HvG alleles (high resolution).
#Copy typing from first allele at each locus to second in cases of homozygosity. This will ensure accurate matching.
(Case_full <- Case
   %>% mutate(across(where(is.character), ~na_if(., "")))
   %>% mutate(mA2Cd.recipient = coalesce(mA2Cd.recipient, mA1Cd.recipient))  
   %>% mutate(mB2Cd.recipient = coalesce(mB2Cd.recipient, mB1Cd.recipient)) 
   %>% mutate(mC2Cd.recipient = coalesce(mC2Cd.recipient, mC1Cd.recipient)) 
   %>% mutate(mDRB12Cd.recipient = coalesce(mDRB12Cd.recipient, mDRB11Cd.recipient)) 
   %>% mutate(mDQA12Cd.recipient = coalesce(mDQA12Cd.recipient, mDQA11Cd.recipient)) 
   %>% mutate(mDQB12cd.recipient = coalesce(mDQB12cd.recipient, mDQB11cd.recipient)) 
   %>% mutate(mDPA12Cd.recipient = coalesce(mDPA12Cd.recipient, mDPA11Cd.recipient)) 
   %>% mutate(mDPB12cd.recipient = coalesce(mDPB12cd.recipient, mDPB11cd.recipient))
  
   %>% mutate(mA2Cd.donor = coalesce(mA2Cd.donor, mA1Cd.donor))  
   %>% mutate(mB2Cd.donor = coalesce(mB2Cd.donor, mB1Cd.donor)) 
   %>% mutate(mC2Cd.donor = coalesce(mC2Cd.donor, mC1Cd.donor)) 
   %>% mutate(mDRB12Cd.donor = coalesce(mDRB12Cd.donor, mDRB11Cd.donor)) 
   %>% mutate(mDQA12Cd.donor = coalesce(mDQA12Cd.donor, mDQA11Cd.donor)) 
   %>% mutate(mDQB12cd.donor = coalesce(mDQB12cd.donor, mDQB11cd.donor)) 
   %>% mutate(mDPA12Cd.donor = coalesce(mDPA12Cd.donor, mDPA11Cd.donor)) 
   %>% mutate(mDPB12cd.donor = coalesce(mDPB12cd.donor, mDPB11cd.donor))
   )

#The mutate function makes new columns for mismatches at each locus. For the first line of code, the code makes a new column called "A.1.HvG," and then looks at the value of "mA1Cd.donor" to see if it is present in either "mA1Cd.recipient" or "mA2Cd.recipient." If it finds the value in either, then it records "NA" in "A.1.HvG." The "TRUE" argument copies the value of "mA1Cd.donor" whenever that value is not found in either of the recipient columns. An easier way to understand this is to see that "case_when" is similar to "if_else:" if the value of "mA1Cd.donor" is found in either "mA1Cd.recipient" or "mA2Cd.recipient," then record "NA," else, copy the value of "mA1Cd.donor."

(Case_MM_HR <- Case_full 
 #A locus mismatches
   %>% mutate(A.1.HvG = case_when(mA1Cd.donor == mA1Cd.recipient | mA1Cd.donor == mA2Cd.recipient ~ NA_character_, TRUE ~ as.character(mA1Cd.donor)), A.1.HvG = case_when(!is.na(A.1.HvG) ~ str_glue("A*{A.1.HvG}"))) 
   %>% mutate(A.2.HvG = case_when(mA2Cd.donor == mA1Cd.recipient | mA2Cd.donor == mA2Cd.recipient ~ NA_character_, TRUE ~ as.character(mA2Cd.donor)), A.2.HvG = case_when(!is.na(A.2.HvG) ~ str_glue("A*{A.2.HvG}")))
#B locus mismatches 
   %>% mutate(B.1.HvG = case_when(mB1Cd.donor == mB1Cd.recipient | mB1Cd.donor == mB2Cd.recipient ~ NA_character_, TRUE ~ as.character(mB1Cd.donor)), B.1.HvG = case_when(!is.na(B.1.HvG) ~ str_glue("B*{B.1.HvG}"))) 
   %>% mutate(B.2.HvG = case_when(mB2Cd.donor == mB1Cd.recipient | mB2Cd.donor == mB2Cd.recipient ~ NA_character_, TRUE ~ as.character(mB2Cd.donor)), B.2.HvG = case_when(!is.na(B.2.HvG) ~ str_glue("B*{B.2.HvG}")))
#C locus mismatches 
   %>% mutate(C.1.HvG = case_when(mC1Cd.donor == mC1Cd.recipient | mC1Cd.donor == mC2Cd.recipient ~ NA_character_, TRUE ~ as.character(mC1Cd.donor)), C.1.HvG = case_when(!is.na(C.1.HvG) ~ str_glue("C*{C.1.HvG}"))) 
   %>% mutate(C.2.HvG = case_when(mC2Cd.donor == mC1Cd.recipient | mC2Cd.donor == mC2Cd.recipient ~ NA_character_, TRUE ~ as.character(mC2Cd.donor)), C.2.HvG = case_when(!is.na(C.2.HvG) ~ str_glue("C*{C.2.HvG}")))
#DRB1 locus mismatches 
   %>% mutate(DRB1.1.HvG = case_when(mDRB11Cd.donor == mDRB11Cd.recipient | mDRB11Cd.donor == mDRB12Cd.recipient ~ NA_character_, TRUE ~ as.character(mDRB11Cd.donor)), DRB1.1.HvG = case_when(!is.na(DRB1.1.HvG) ~ str_glue("DRB1*{DRB1.1.HvG}"))) 
   %>% mutate(DRB1.2.HvG = case_when(mDRB12Cd.donor == mDRB11Cd.recipient | mDRB12Cd.donor == mDRB12Cd.recipient ~ NA_character_, TRUE ~ as.character(mDRB12Cd.donor)), DRB1.2.HvG = case_when(!is.na(DRB1.2.HvG) ~ str_glue("DRB1*{DRB1.2.HvG}")))
#DRB3 locus mismatches
%>% mutate(DRB3.1.HvG = case_when(mDRB31cd.donor == mDRB31cd.recipient | mDRB31cd.donor == mDRB32cd.recipient ~ NA_character_, TRUE ~ as.character(mDRB31cd.donor)), DRB3.1.HvG = case_when(!is.na(DRB3.1.HvG) ~ str_glue("DRB3*{DRB3.1.HvG}"))) 
   %>% mutate(DRB3.2.HvG = case_when(mDRB32cd.donor == mDRB31cd.recipient | mDRB32cd.donor == mDRB32cd.recipient ~ NA_character_, TRUE ~ as.character(mDRB32cd.donor)), DRB3.2.HvG = case_when(!is.na(DRB3.2.HvG) ~ str_glue("DRB3*{DRB3.2.HvG}")))
#DRB4 locus mismatches
%>% mutate(DRB4.1.HvG = case_when(mDRB41cd.donor == mDRB41cd.recipient | mDRB41cd.donor == mDRB42cd.recipient ~ NA_character_, TRUE ~ as.character(mDRB41cd.donor)), DRB4.1.HvG = case_when(!is.na(DRB4.1.HvG) ~ str_glue("DRB4*{DRB4.1.HvG}"))) 
   %>% mutate(DRB4.2.HvG = case_when(mDRB42cd.donor == mDRB41cd.recipient | mDRB42cd.donor == mDRB42cd.recipient ~ NA_character_, TRUE ~ as.character(mDRB42cd.donor)), DRB4.2.HvG = case_when(!is.na(DRB4.2.HvG) ~ str_glue("DRB4*{DRB4.2.HvG}")))
#DRB5 locus mismatches
%>% mutate(DRB5.1.HvG = case_when(mDRB51cd.donor == mDRB51cd.recipient | mDRB51cd.donor == mDRB52cd.recipient ~ NA_character_, TRUE ~ as.character(mDRB51cd.donor)), DRB5.1.HvG = case_when(!is.na(DRB5.1.HvG) ~ str_glue("DRB5*{DRB5.1.HvG}"))) 
   %>% mutate(DRB5.2.HvG = case_when(mDRB52cd.donor == mDRB51cd.recipient | mDRB52cd.donor == mDRB52cd.recipient ~ NA_character_, TRUE ~ as.character(mDRB52cd.donor)), DRB5.2.HvG = case_when(!is.na(DRB5.2.HvG) ~ str_glue("DRB5*{DRB5.2.HvG}")))
#DQB1 locus mismatches 
   %>% mutate(DQB1.1.HvG = case_when(mDQB11cd.donor == mDQB11cd.recipient | mDQB11cd.donor == mDQB12cd.recipient ~ NA_character_, TRUE ~ as.character(mDQB11cd.donor)), DQB1.1.HvG = case_when(!is.na(DQB1.1.HvG) ~ str_glue("DQB1*{DQB1.1.HvG}"))) 
   %>% mutate(DQB1.2.HvG = case_when(mDQB12cd.donor == mDQB11cd.recipient | mDQB12cd.donor == mDQB12cd.recipient ~ NA_character_, TRUE ~ as.character(mDQB12cd.donor)), DQB1.2.HvG = case_when(!is.na(DQB1.2.HvG) ~ str_glue("DQB1*{DQB1.2.HvG}")))
#DPB1 locus mismatches 
   %>% mutate(DPB1.1.HvG = case_when(mDPB11cd.donor == mDPB11cd.recipient | mDPB11cd.donor == mDPB12cd.recipient ~ NA_character_, TRUE ~ as.character(mDPB11cd.donor)), DPB1.1.HvG = case_when(!is.na(DPB1.1.HvG) ~ str_glue("DPB1*{DPB1.1.HvG}"))) 
   %>% mutate(DPB1.2.HvG = case_when(mDPB12cd.donor == mDPB11cd.recipient | mDPB12cd.donor == mDPB12cd.recipient ~ NA_character_, TRUE ~ as.character(mDPB12cd.donor)), DPB1.2.HvG = case_when(!is.na(DPB1.2.HvG) ~ str_glue("DPB1*{DPB1.2.HvG}")))
   )

#Calculate mismatches at low resolution, at the A, B, C, DR, DQ, DQA, DPA and DP loci. 
(Case_MM <- Case_MM_HR 
   %>% mutate(A.1.mismatch = case_when(A1Cd.donor == A1Cd.recipient | A1Cd.donor == A2Cd.recipient ~ NA_character_, TRUE ~ as.character(A1Cd.donor))) 
   %>% mutate(A.2.mismatch = case_when(A2Cd.donor == A1Cd.recipient | A2Cd.donor == A2Cd.recipient ~ NA_character_, TRUE ~ as.character(A2Cd.donor)))
   %>% mutate(B.1.mismatch = case_when(B1Cd.donor == B1Cd.recipient | B1Cd.donor == B2Cd.recipient ~ NA_character_, TRUE ~ as.character(B1Cd.donor))) 
   %>% mutate(B.2.mismatch = case_when(B2Cd.donor == B1Cd.recipient | B2Cd.donor == B2Cd.recipient ~ NA_character_, TRUE ~ as.character(B2Cd.donor)))
   %>% mutate(Bw.1.mismatch = case_when(BW1Cd.donor == BW1Cd.recipient | BW1Cd.donor == Bw2Cd.recipient ~ NA_character_, TRUE ~ as.character(BW1Cd.donor))) 
   %>% mutate(Bw.2.mismatch = case_when(Bw2Cd.donor == BW1Cd.recipient | Bw2Cd.donor == Bw2Cd.recipient ~ NA_character_, TRUE ~ as.character(Bw2Cd.donor)))
   %>% mutate(Cw.1.mismatch = case_when(Cw1Cd.donor == Cw1Cd.recipient | Cw1Cd.donor == Cw2Cd.recipient ~ NA_character_, TRUE ~ as.character(Cw1Cd.donor))) 
   %>% mutate(Cw.2.mismatch = case_when(Cw2Cd.donor == Cw1Cd.recipient | Cw2Cd.donor == Cw2Cd.recipient ~ NA_character_, TRUE ~ as.character(Cw2Cd.donor)))
   %>% mutate(DR.1.mismatch = case_when(DR1Cd.donor == DR1Cd.recipient | DR1Cd.donor == DR2Cd.recipient ~ NA_character_, TRUE ~ as.character(DR1Cd.donor))) 
   %>% mutate(DR.2.mismatch = case_when(DR2Cd.donor == DR1Cd.recipient | DR2Cd.donor == DR2Cd.recipient ~ NA_character_, TRUE ~ as.character(DR2Cd.donor)))
   %>% mutate(DR.51.52.53.1.mismatch = case_when(drw1cd.donor == drw1cd.recipient | drw1cd.donor == drw2cd.recipient ~ NA_character_, TRUE ~ as.character(drw1cd.donor)))
   %>% mutate(DR.51.52.53.2.mismatch = case_when(drw2cd.donor == drw1cd.recipient | drw2cd.donor == drw2cd.recipient ~ NA_character_, TRUE ~ as.character(drw2cd.donor)))
   %>% mutate(DQ.1.mismatch = case_when(dq1cd.donor == dq1cd.recipient | dq1cd.donor == dq2cd.recipient ~ NA_character_, TRUE ~ as.character(dq1cd.donor))) 
   %>% mutate(DQ.2.mismatch = case_when(dq2cd.donor == dq1cd.recipient | dq2cd.donor == dq2cd.recipient ~ NA_character_, TRUE ~ as.character(dq2cd.donor)))
   %>% mutate(DQA.1.mismatch = case_when(DQA1.1.LR.donor == DQA1.1.LR.recipient | DQA1.1.LR.donor == DQA1.2.LR.recipient ~ NA_character_, TRUE ~ as.character(DQA1.1.LR.donor))) 
   %>% mutate(DQA.2.mismatch = case_when(DQA1.2.LR.donor == DQA1.1.LR.recipient | DQA1.2.LR.donor == DQA1.2.LR.recipient ~ NA_character_, TRUE ~ as.character(DQA1.2.LR.donor)))
   %>% mutate(DP.1.mismatch = case_when(DP1Cd.donor == DP1Cd.recipient | DP1Cd.donor == DP2Cd.recipient ~ NA_character_, TRUE ~ as.character(DP1Cd.donor))) 
   %>% mutate(DP.2.mismatch = case_when(DP2Cd.donor == DP1Cd.recipient | DP2Cd.donor == DP2Cd.recipient ~ NA_character_, TRUE ~ as.character(DP2Cd.donor)))
   %>% mutate(DPA.1.mismatch = case_when(DPA1.1.LR.donor == DPA1.1.LR.recipient | DPA1.1.LR.donor == DPA1.2.LR.recipient ~ NA_character_, TRUE ~ as.character(DPA1.1.LR.donor))) 
   %>% mutate(DPA.2.mismatch = case_when(DPA1.2.LR.donor == DPA1.1.LR.recipient | DPA1.2.LR.donor == DPA1.2.LR.recipient ~ NA_character_, TRUE ~ as.character(DPA1.2.LR.donor)))
  
#Place "A," "DR," etc. at the beginning of mismatches so they will show up properly on the report.
  %>% mutate(A.1.mismatch = case_when(!is.na(A.1.mismatch) ~ str_glue("A{A.1.mismatch}"), TRUE ~ NA_character_))
  %>% mutate(A.2.mismatch = case_when(!is.na(A.2.mismatch) ~ str_glue("A{A.2.mismatch}"), TRUE ~ NA_character_))
  %>% mutate(B.1.mismatch = case_when(!is.na(B.1.mismatch) ~ str_glue("B{B.1.mismatch}"), TRUE ~ NA_character_))
  %>% mutate(B.2.mismatch = case_when(!is.na(B.2.mismatch) ~ str_glue("B{B.2.mismatch}"), TRUE ~ NA_character_))
  %>% mutate(Bw.1.mismatch = case_when(!is.na(Bw.1.mismatch) ~ str_glue("Bw{Bw.1.mismatch}"), TRUE ~ NA_character_))
  %>% mutate(Bw.2.mismatch = case_when(!is.na(Bw.2.mismatch) ~ str_glue("Bw{Bw.2.mismatch}"), TRUE ~ NA_character_))
  %>% mutate(Cw.1.mismatch = case_when(!is.na(Cw.1.mismatch) ~ str_glue("Cw{Cw.1.mismatch}"), TRUE ~ NA_character_))
  %>% mutate(Cw.2.mismatch = case_when(!is.na(Cw.2.mismatch) ~ str_glue("Cw{Cw.2.mismatch}"), TRUE ~ NA_character_))
  %>% mutate(DR.1.mismatch = case_when(!is.na(DR.1.mismatch) ~ str_glue("DR{DR.1.mismatch}"), TRUE ~ NA_character_))
  %>% mutate(DR.2.mismatch = case_when(!is.na(DR.2.mismatch) ~ str_glue("DR{DR.2.mismatch}"), TRUE ~ NA_character_))
  %>% mutate(DR.51.52.53.1.mismatch = case_when(!is.na(DR.51.52.53.1.mismatch) ~ str_glue("DR{DR.51.52.53.1.mismatch}"), TRUE ~ NA_character_))
  %>% mutate(DR.51.52.53.2.mismatch = case_when(!is.na(DR.51.52.53.2.mismatch) ~ str_glue("DR{DR.51.52.53.2.mismatch}"), TRUE ~ NA_character_))
  %>% mutate(DQ.1.mismatch = case_when(!is.na(DQ.1.mismatch) ~ str_glue("DQ{DQ.1.mismatch}"), TRUE ~ NA_character_))
  %>% mutate(DQ.2.mismatch = case_when(!is.na(DQ.2.mismatch) ~ str_glue("DQ{DQ.2.mismatch}"), TRUE ~ NA_character_))
  %>% mutate(DQA.1.mismatch = case_when(!is.na(DQA.1.mismatch) ~ str_glue("DQA1*{DQA.1.mismatch}"), TRUE ~ NA_character_))
  %>% mutate(DQA.2.mismatch = case_when(!is.na(DQA.2.mismatch) ~ str_glue("DQA1*{DQA.2.mismatch}"), TRUE ~ NA_character_))
  %>% mutate(DP.1.mismatch = case_when(!is.na(DP.1.mismatch) ~ str_glue("DP{DP.1.mismatch}"), TRUE ~ NA_character_))
  %>% mutate(DP.2.mismatch = case_when(!is.na(DP.2.mismatch) ~ str_glue("DP{DP.2.mismatch}"), TRUE ~ NA_character_))
  %>% mutate(DPA.1.mismatch = case_when(!is.na(DPA.1.mismatch) ~ str_glue("DPA1*{DPA.1.mismatch}"), TRUE ~ NA_character_))
  %>% mutate(DPA.2.mismatch = case_when(!is.na(DPA.2.mismatch) ~ str_glue("DPA1*{DPA.2.mismatch}"), TRUE ~ NA_character_))  
 
#Place "A," "DR," etc. at the beginning of donor typing so that the typing will line up with SAB results.
  %>% mutate(A1Cd.donor = case_when(!is.na(A1Cd.donor) ~ str_glue("A{A1Cd.donor}"), TRUE ~ NA_character_))
  %>% mutate(A2Cd.donor = case_when(!is.na(A2Cd.donor) ~ str_glue("A{A2Cd.donor}"), TRUE ~ NA_character_))
  %>% mutate(B1Cd.donor = case_when(!is.na(B1Cd.donor) ~ str_glue("B{B1Cd.donor}"), TRUE ~ NA_character_))
  %>% mutate(B2Cd.donor = case_when(!is.na(B2Cd.donor) ~ str_glue("B{B2Cd.donor}"), TRUE ~ NA_character_))
  %>% mutate(BW1Cd.donor = case_when(!is.na(BW1Cd.donor) ~ str_glue("Bw{BW1Cd.donor}"), TRUE ~ NA_character_))
  %>% mutate(Bw2Cd.donor = case_when(!is.na(Bw2Cd.donor) ~ str_glue("Bw{Bw2Cd.donor}"), TRUE ~ NA_character_))
  %>% mutate(Cw1Cd.donor = case_when(!is.na(Cw1Cd.donor) ~ str_glue("Cw{Cw1Cd.donor}"), TRUE ~ NA_character_))
  %>% mutate(Cw2Cd.donor = case_when(!is.na(Cw2Cd.donor) ~ str_glue("Cw{Cw2Cd.donor}"), TRUE ~ NA_character_))
  %>% mutate(DR1Cd.donor = case_when(!is.na(DR1Cd.donor) ~ str_glue("DR{DR1Cd.donor}"), TRUE ~ NA_character_))
  %>% mutate(DR2Cd.donor = case_when(!is.na(DR2Cd.donor) ~ str_glue("DR{DR2Cd.donor}"), TRUE ~ NA_character_))
  %>% mutate(drw1cd.donor = case_when(!is.na(drw1cd.donor) ~ str_glue("DR{drw1cd.donor}"), TRUE ~ NA_character_))
  %>% mutate(drw2cd.donor = case_when(!is.na(drw2cd.donor) ~ str_glue("DR{drw2cd.donor}"), TRUE ~ NA_character_))
  %>% mutate(dq1cd.donor = case_when(!is.na(dq1cd.donor) ~ str_glue("DQ{dq1cd.donor}"), TRUE ~ NA_character_))
  %>% mutate(dq2cd.donor = case_when(!is.na(dq2cd.donor) ~ str_glue("DQ{dq2cd.donor}"), TRUE ~ NA_character_))
  %>% mutate(mDQA11Cd.donor = case_when(!is.na(mDQA11Cd.donor) ~ str_glue("DQA1*{mDQA11Cd.donor}"), TRUE ~ NA_character_))
  %>% mutate(mDQA12Cd.donor = case_when(!is.na(mDQA12Cd.donor) ~ str_glue("DQA1*{mDQA12Cd.donor}"), TRUE ~ NA_character_))
  %>% mutate(DP1Cd.donor = case_when(!is.na(DP1Cd.donor) ~ str_glue("DP{DP1Cd.donor}"), TRUE ~ NA_character_))
  %>% mutate(DP2Cd.donor = case_when(!is.na(DP2Cd.donor) ~ str_glue("DP{DP2Cd.donor}"), TRUE ~ NA_character_))
  %>% mutate(mDPA11Cd.donor = case_when(!is.na(mDPA11Cd.donor) ~ str_glue("DPA1*{mDPA11Cd.donor}"), TRUE ~ NA_character_))
  %>% mutate(mDPA12Cd.donor = case_when(!is.na(mDPA12Cd.donor) ~ str_glue("DPA1*{mDPA12Cd.donor}"), TRUE ~ NA_character_))
  )

```

```{r include=FALSE}
#Get information on SAB tests

#Connecting to the Test table in HisoTrac.
(Test <- tbl(con, "Test") 
  %>% select(TestId:TestTypeCd, TestMethodCd, SpecificityTxt, ModerateRiskAntibodyTxt, LowRiskAntibodyTxt)
)

#Connecting to the TestDetail table in HisoTrac.
(TestDetail <- tbl(con, "TestDetail") 
  %>% select(TestId, TestDetailTypeCd, SingleAgBead, SingleAgRaw, SingleAgNormalized, SingleAgSpecAbbr, SingleAgSpecificity)
)

#Connecting to the Sample table in HisoTrac.
(Sample <- tbl(con, "Sample") 
  %>% select(PatientId, SampleID, SampleNbr, SampleDt, SpecimenTypeCd, StatusCd)
  %>% rename(SampleId = SampleID)
  #Filter for the samples for this patient.
  %>% filter(PatientId == Patient_Id)
  %>% left_join(Test, by = "SampleId")
  %>% filter(TestMethodCd == "Class I SAB" | TestMethodCd == "Class II SAB")
  %>% left_join(TestDetail, by = "TestId")
  %>% filter(!is.na(SingleAgNormalized))
  %>% as_tibble
)

#Join the SAB tests to the table with recipient and donor information.
(Case_MM_SAB_tests <- Case_MM
   %>% left_join(Sample, by = "PatientId")
  #Separate the Bw4/w6 specificities into a separate column.
   %>% separate(SingleAgSpecAbbr, sep = ",", into = c("SAB_sero_spec", "SAB_Bw4Bw6_spec"), fill = "right")
  
   #Separate DQA and DQB specificities into separate columns.
   %>% separate(SingleAgSpecificity, sep = ",", into = c("SingleAgSpecificity.A", "SingleAgSpecificity.B"), fill = "right")
  #Replace all "NA" values with "blank," otherwise the DSA matching with think that anything with an "NA" value is a DSA.
   %>% mutate(SingleAgSpecificity.B = replace_na(SingleAgSpecificity.B, "blank"))
  
  #Extract first field DQA1 and DPA1 typing into a separate column for low res DQA and DPA DSA determination.
  %>% mutate(DPA_DQA_LR_specificity = str_extract(SingleAgSpecificity.A, "D[:alpha:]A1\\*[:digit:]+"))
  #Replace all "NA" values with "blank," otherwise the DSA matching with think that anything with an "NA" value is a DSA.
  %>% mutate(DPA_DQA_LR_specificity = replace_na(DPA_DQA_LR_specificity, "blank"))
  
#Ab results strings separated into strong, moderate, weak, and then combined into a total "positive" result, per locus.
  %>% mutate(strong_Ab_A = str_extract(SpecificityTxt, "(?<![:alpha:])A.+"))
  %>% mutate(strong_Ab_A = str_extract(strong_Ab_A, "(?<=A:).+"))
  %>% mutate(moderate_Ab_A = str_extract(ModerateRiskAntibodyTxt, "(?<![:alpha:])A.+"))
  %>% mutate(moderate_Ab_A = str_extract(moderate_Ab_A, "(?<=A:).+"))
  %>% mutate(weak_Ab_A = str_extract(LowRiskAntibodyTxt, "(?<![:alpha:])A.+"))
  %>% mutate(weak_Ab_A = str_extract(weak_Ab_A, "(?<=A:).+"))
  %>% mutate(pos_Ab_A = str_glue("{strong_Ab_A} {moderate_Ab_A} {weak_Ab_A}"))
  %>% mutate(pos_Ab_A = str_replace_all(pos_Ab_A, "NA", ""))
  
  %>% mutate(strong_Ab_B = str_extract(SpecificityTxt, "(?<![:alpha:])B.+"))
  %>% mutate(strong_Ab_B = str_extract(strong_Ab_B, "(?<=B:).+"))
  %>% mutate(moderate_Ab_B = str_extract(ModerateRiskAntibodyTxt, "(?<![:alpha:])B.+"))
  %>% mutate(moderate_Ab_B = str_extract(moderate_Ab_B, "(?<=B:).+"))
  %>% mutate(weak_Ab_B = str_extract(LowRiskAntibodyTxt, "(?<![:alpha:])B.+"))
  %>% mutate(weak_Ab_B = str_extract(weak_Ab_B, "(?<=B:).+"))
  %>% mutate(pos_Ab_B = str_glue("{strong_Ab_B} {moderate_Ab_B} {weak_Ab_B}"))
  %>% mutate(pos_Ab_B = str_replace_all(pos_Ab_B, "NA", ""))
  
  %>% mutate(strong_Ab_Cw = str_extract(SpecificityTxt, "(?<=Cw:).+"))
  %>% mutate(moderate_Ab_Cw = str_extract(ModerateRiskAntibodyTxt, "(?<=Cw:).+"))
  %>% mutate(weak_Ab_Cw = str_extract(LowRiskAntibodyTxt, "(?<=Cw:).+"))
  %>% mutate(pos_Ab_Cw = str_glue("{strong_Ab_Cw} {moderate_Ab_Cw} {weak_Ab_Cw}"))
  %>% mutate(pos_Ab_Cw = str_replace_all(pos_Ab_Cw, "NA", ""))
  
  %>% mutate(strong_Ab_DR = str_extract(SpecificityTxt, "(?<=DR:).+"))
  %>% mutate(moderate_Ab_DR = str_extract(ModerateRiskAntibodyTxt, "(?<=DR:).+"))
  %>% mutate(weak_Ab_DR = str_extract(LowRiskAntibodyTxt, "(?<=DR:).+"))
  %>% mutate(pos_Ab_DR = str_glue("{strong_Ab_DR} {moderate_Ab_DR} {weak_Ab_DR}"))
  %>% mutate(pos_Ab_DR = str_replace_all(pos_Ab_DR, "NA", ""))
 
  %>% mutate(strong_Ab_DR5X = str_extract(SpecificityTxt, "(?<=DRw:).+"))
  %>% mutate(moderate_Ab_DR5X = str_extract(ModerateRiskAntibodyTxt, "(?<=DRw:).+"))
  %>% mutate(weak_Ab_DR5X = str_extract(LowRiskAntibodyTxt, "(?<=DRw:).+"))
  %>% mutate(pos_Ab_DR5X = str_glue("{strong_Ab_DR5X} {moderate_Ab_DR5X} {weak_Ab_DR5X}"))
  %>% mutate(pos_Ab_DR5X = str_replace_all(pos_Ab_DR5X, "NA", ""))
  
  %>% mutate(strong_Ab_DQ = str_extract(SpecificityTxt, "(?<=DQ:).+"))
  %>% mutate(moderate_Ab_DQ = str_extract(ModerateRiskAntibodyTxt, "(?<=DQ:).+"))
  %>% mutate(weak_Ab_DQ = str_extract(LowRiskAntibodyTxt, "(?<=DQ:).+"))
  %>% mutate(pos_Ab_DQ = str_glue("{strong_Ab_DQ} {moderate_Ab_DQ} {weak_Ab_DQ}"))
  %>% mutate(pos_Ab_DQ = str_replace_all(pos_Ab_DQ, "NA", ""))
 
  %>% mutate(strong_Ab_DQA = str_extract(SpecificityTxt, "(?<=DQA:).+"))
  %>% mutate(moderate_Ab_DQA = str_extract(ModerateRiskAntibodyTxt, "(?<=DQA:).+"))
  %>% mutate(weak_Ab_DQA = str_extract(LowRiskAntibodyTxt, "(?<=DQA:).+"))
  %>% mutate(pos_Ab_DQA = str_glue("{strong_Ab_DQA} {moderate_Ab_DQA} {weak_Ab_DQA}"))
  %>% mutate(pos_Ab_DQA = str_replace_all(pos_Ab_DQA, "NA", ""))
  
  %>% mutate(strong_Ab_DP = str_extract(SpecificityTxt, "(?<=DP:).+"))
  %>% mutate(moderate_Ab_DP = str_extract(ModerateRiskAntibodyTxt, "(?<=DP:).+"))
  %>% mutate(weak_Ab_DP = str_extract(LowRiskAntibodyTxt, "(?<=DP:).+"))
  %>% mutate(pos_Ab_DP = str_glue("{strong_Ab_DP} {moderate_Ab_DP} {weak_Ab_DP}"))
  %>% mutate(pos_Ab_DP = str_replace_all(pos_Ab_DP, "NA", ""))
 
  %>% mutate(strong_Ab_DPA = str_extract(SpecificityTxt, "(?<=DPA:).+"))
  %>% mutate(moderate_Ab_DPA = str_extract(ModerateRiskAntibodyTxt, "(?<=DPA:).+"))
  %>% mutate(weak_Ab_DPA = str_extract(LowRiskAntibodyTxt, "(?<=DPA:).+"))
  %>% mutate(pos_Ab_DPA = str_glue("{strong_Ab_DPA} {moderate_Ab_DPA} {weak_Ab_DPA}"))
  %>% mutate(pos_Ab_DPA = str_replace_all(pos_Ab_DPA, "NA", ""))  
)
```

```{r include=FALSE}
#Class I: Record positive antibodies from results, by locus.

#A
(Case_MM_SAB_tests_A <- Case_MM_SAB_tests
#Separate each specificity into a new row
  %>% distinct(TestId, .keep_all = TRUE)
  %>% separate_rows(pos_Ab_A, sep = " ")
  %>% mutate(pos_Ab_A = str_replace_all(pos_Ab_A, " ", ""))
  %>% filter(pos_Ab_A != "")
  %>% select(SampleId, pos_Ab_A)
  %>% distinct(SampleId, pos_Ab_A, .keep_all = TRUE)
#Clean up specificities
#This adds a colon to allele-specific antibodies that don't have a colon
  %>% mutate(pos_Ab_A = case_when(str_detect(pos_Ab_A, "[:digit:]{4}") ~ stri_sub_replace(pos_Ab_A, 3,2, value = ":"), TRUE ~ as.character(pos_Ab_A)))
#Add an "A" to serologic specificities, and "A*" to allelic specificities
  %>% mutate(pos_Ab_A = case_when(
    str_detect(pos_Ab_A, ":", negate = TRUE) ~ str_replace(pos_Ab_A, "^", "A"),
    str_detect(pos_Ab_A, ":") ~ str_replace(pos_Ab_A, "^", "A*")
    )
  )
#Collapse all specificities to a single row
  %>% group_by(SampleId)
  %>% summarize(pos_Ab_A = toString(pos_Ab_A))
  %>% ungroup
#Add a comma to the end of the specificities.
  %>% mutate(pos_Ab_A = as.character(str_glue("{pos_Ab_A},")))
)

#B
#A few results listed "Bw4A," which indicated Aw4 reactivity. Since all of these would have listed all of the positive A specificities, and because leaving "Bw4A" won't make a difference, I am leaving it in.
(Case_MM_SAB_tests_B <- Case_MM_SAB_tests
#Separate each specificity into a new row
  %>% distinct(TestId, .keep_all = TRUE)
  %>% separate_rows(pos_Ab_B, sep = " ")
  %>% mutate(pos_Ab_B = str_replace_all(pos_Ab_B, " ", ""))
  %>% filter(pos_Ab_B != "")
  %>% select(SampleId, pos_Ab_B)
  %>% distinct(SampleId, pos_Ab_B, .keep_all = TRUE)
#Clean up specificities
#This adds a colon to allele-specific antibodies that don't have colon
  %>% mutate(pos_Ab_B = case_when(str_detect(pos_Ab_B, "[:digit:]{4}") ~ stri_sub_replace(pos_Ab_B, 3,2, value = ":"), TRUE ~ as.character(pos_Ab_B)))
#Add a "B" to serologic specificities, and "B*" to allelic specificities; keep Bw4/w6 as is.
  %>% mutate(pos_Ab_B = case_when(
    str_detect(pos_Ab_B, "Bw") ~ as.character(pos_Ab_B),
    str_detect(pos_Ab_B, ":", negate = TRUE) ~ str_replace(pos_Ab_B, "^", "B"),
    str_detect(pos_Ab_B, ":") ~ str_replace(pos_Ab_B, "^", "B*")
    )
  )
#Collapse all specificities to a single row
  %>% group_by(SampleId)
  %>% summarize(pos_Ab_B = toString(pos_Ab_B))
  %>% ungroup
#Add a comma to the end of the specificities.
  %>% mutate(pos_Ab_B = as.character(str_glue("{pos_Ab_B},")))
)

#C
(Case_MM_SAB_tests_Cw <- Case_MM_SAB_tests
#Separate each specificity into a new row
  %>% distinct(TestId, .keep_all = TRUE)
  %>% separate_rows(pos_Ab_Cw, sep = " ")
  %>% mutate(pos_Ab_Cw = str_replace_all(pos_Ab_Cw, " ", ""))
  %>% filter(pos_Ab_Cw != "")
  %>% select(SampleId, pos_Ab_Cw)
  %>% distinct(SampleId, pos_Ab_Cw, .keep_all = TRUE)
#Clean up specificities
#Some specificities are recorded with as "01" instead of "1." This removes the leading zeros.
  %>% mutate(pos_Ab_Cw = case_when(
    str_detect(pos_Ab_Cw, "^0[:digit:](?!.)") ~ str_replace(pos_Ab_Cw, "^0", ""),
    TRUE ~ as.character(pos_Ab_Cw)
    )
  )
#This adds a colon to allele-specific antibodies that don't have colon
  %>% mutate(pos_Ab_Cw = case_when(str_detect(pos_Ab_Cw, "[:digit:]{4}") ~ stri_sub_replace(pos_Ab_Cw, 3,2, value = ":"), TRUE ~ as.character(pos_Ab_Cw)))
#Add an "Cw" to serologic specificities, and "C*" to allelic specificities
  %>% mutate(pos_Ab_Cw = case_when(
    str_detect(pos_Ab_Cw, ":", negate = TRUE) ~ str_replace(pos_Ab_Cw, "^", "Cw"),
    str_detect(pos_Ab_Cw, ":") ~ str_replace(pos_Ab_Cw, "^", "C*")
    )
  )
#Collapse all specificities to a single row
  %>% group_by(SampleId)
  %>% summarize(pos_Ab_Cw = toString(pos_Ab_Cw))
  %>% ungroup
#Add a comma to the end of the specificities.
  %>% mutate(pos_Ab_Cw = as.character(str_glue("{pos_Ab_Cw},")))
)

#Filter the master table for CI results and join to tables made in this chunk.
(Case_MM_SAB_tests_C1 <- Case_MM_SAB_tests
  %>% filter(TestMethodCd == "Class I SAB")
  %>% left_join(Case_MM_SAB_tests_A, by = "SampleId", suffix = c("_raw", "_clean"))
  %>% left_join(Case_MM_SAB_tests_B, by = "SampleId", suffix = c("_raw", "_clean"))
  %>% left_join(Case_MM_SAB_tests_Cw, by = "SampleId", suffix = c("_raw", "_clean"))
#Join A, B, and C to a single class I positive value.
  %>% mutate(pos_Ab_C1 = str_glue("{pos_Ab_A_clean} {pos_Ab_B_clean} {pos_Ab_Cw_clean}"))
  %>% mutate(pos_Ab_C1 = str_replace_all(pos_Ab_C1, "NA", ""))
  %>% mutate(pos_Ab_C1 = str_trim(pos_Ab_C1))
  %>% mutate(pos_Ab_C1 = na_if(pos_Ab_C1, ""))
#Select only the sample number and the CI results
  %>% select(SampleNbr, pos_Ab_C1)
  %>% mutate(pos_Ab_C1 = replace_na(pos_Ab_C1, "negative"))
  %>% mutate(TestMethodCd = "Class I SAB")
)

```

```{r include=FALSE}
#Class II: Record positive antibodies from results, by locus.

#DRB1
(Case_MM_SAB_tests_DR <- Case_MM_SAB_tests
#Separate each specificity into a new row
  %>% distinct(TestId, .keep_all = TRUE)
  %>% separate_rows(pos_Ab_DR, sep = " ")
  %>% mutate(pos_Ab_DR = str_replace_all(pos_Ab_DR, " ", ""))
  %>% filter(pos_Ab_DR != "")
  %>% select(SampleId, pos_Ab_DR)
  %>% distinct(SampleId, pos_Ab_DR, .keep_all = TRUE)
#Clean up specificities
#This adds a colon to allele-specific antibodies that don't have a colon
  %>% mutate(pos_Ab_DR = case_when(str_detect(pos_Ab_DR, "[:digit:]{4}") ~ stri_sub_replace(pos_Ab_DR, 3,2, value = ":"), TRUE ~ as.character(pos_Ab_DR)))
#Add an "DR" to serologic specificities, and "DRB1*" to allelic specificities
  %>% mutate(pos_Ab_DR = case_when(
    str_detect(pos_Ab_DR, ":", negate = TRUE) ~ str_replace(pos_Ab_DR, "^", "DR"),
    str_detect(pos_Ab_DR, ":") ~ str_replace(pos_Ab_DR, "^", "DRB1*")
    ))
#Collapse all specificities to a single row
  %>% group_by(SampleId)
  %>% summarize(pos_Ab_DR = toString(pos_Ab_DR))
  %>% ungroup
#Add a comma to the end of the specificities.
  %>% mutate(pos_Ab_DR = as.character(str_glue("{pos_Ab_DR},")))
)

#DRB3/4/5
(Case_MM_SAB_tests_DR5X <- Case_MM_SAB_tests
#Separate each specificity into a new row
  %>% distinct(TestId, .keep_all = TRUE)
  %>% separate_rows(pos_Ab_DR5X, sep = " ")
  %>% mutate(pos_Ab_DR5X = str_replace_all(pos_Ab_DR5X, " ", ""))
  %>% filter(pos_Ab_DR5X != "")
  %>% select(SampleId, pos_Ab_DR5X)
  %>% distinct(SampleId, pos_Ab_DR5X, .keep_all = TRUE)
#Clean up specificities
#Sometimes allele-specific antibodies are prefixed with a B, this removes it to standardize.
  %>% mutate(pos_Ab_DR5X = case_when(
    str_detect(pos_Ab_DR5X, "B") ~ str_replace(pos_Ab_DR5X, "B", ""),
    TRUE ~ as.character(pos_Ab_DR5X)
    ))
#This adds a colon to allele-specific antibodies that don't have a colon
  %>% mutate(pos_Ab_DR5X = case_when(str_detect(pos_Ab_DR5X, "[:digit:]{4}") ~ stri_sub_replace(pos_Ab_DR5X, 5,4, value = ":"), TRUE ~ as.character(pos_Ab_DR5X)))
#A few of the allele-specific results only included the first field; this adds the second field (which is "01" for all of the alleles on the SAB panel).
  %>% mutate(pos_Ab_DR5X = case_when(
    str_detect(pos_Ab_DR5X, "(\\*0[:digit:])$") ~ str_glue("{pos_Ab_DR5X}:01"),
    TRUE ~ as.character(pos_Ab_DR5X)
    ))
#Add a "DR" to serologic specificities, and "DRB*" to allelic specificities
  %>% mutate(pos_Ab_DR5X = case_when(
    str_detect(pos_Ab_DR5X, ":", negate = TRUE) ~ str_replace(pos_Ab_DR5X, "^", "DR"),
    str_detect(pos_Ab_DR5X, ":") ~ str_replace(pos_Ab_DR5X, "^", "DRB")
    ))
#Collapse all specificities to a single row
  %>% group_by(SampleId)
  %>% summarize(pos_Ab_DR5X = toString(pos_Ab_DR5X))
  %>% ungroup
#Add a comma to the end of the specificities.
  %>% mutate(pos_Ab_DR5X = as.character(str_glue("{pos_Ab_DR5X},")))
)

#DQ
(Case_MM_SAB_tests_DQ <- Case_MM_SAB_tests
#Separate each specificity into a new row
  %>% distinct(TestId, .keep_all = TRUE)
  %>% separate_rows(pos_Ab_DQ, sep = " ")
  %>% mutate(pos_Ab_DQ = str_replace_all(pos_Ab_DQ, " ", ""))
  %>% filter(pos_Ab_DQ != "")
  %>% select(SampleId, pos_Ab_DQ)
  %>% distinct(SampleId, pos_Ab_DQ, .keep_all = TRUE)
#Clean up specificities
#This adds a colon to allele-specific antibodies that don't have a colon
  %>% mutate(pos_Ab_DQ = case_when(str_detect(pos_Ab_DQ, "[:digit:]{4}") ~ stri_sub_replace(pos_Ab_DQ, 3,2, value = ":"), TRUE ~ as.character(pos_Ab_DQ)))
#Add an "DQ" to serologic specificities, and "DQB1*" to allelic specificities
  %>% mutate(pos_Ab_DQ = case_when(
    str_detect(pos_Ab_DQ, ":", negate = TRUE) ~ str_replace(pos_Ab_DQ, "^", "DQ"),
    str_detect(pos_Ab_DQ, ":") ~ str_replace(pos_Ab_DQ, "^", "DQB1*")
    ))
#Collapse all specificities to a single row
  %>% group_by(SampleId)
  %>% summarize(pos_Ab_DQ = toString(pos_Ab_DQ))
  %>% ungroup
#Add a comma to the end of the specificities.
  %>% mutate(pos_Ab_DQ = as.character(str_glue("{pos_Ab_DQ},")))
)

#DQA
#Many DQA specificities are reported to just the first field, meaning they won't align properly to the typing on the beads, or on the donor. I think it will be best to create a one-field typing for the SAB beads and donor type.
(Case_MM_SAB_tests_DQA <- Case_MM_SAB_tests
#Separate each specificity into a new row
  %>% distinct(TestId, .keep_all = TRUE)
  %>% separate_rows(pos_Ab_DQA, sep = " ")
  %>% mutate(pos_Ab_DQA = str_replace_all(pos_Ab_DQA, " ", ""))
  %>% filter(pos_Ab_DQA != "")
  %>% select(SampleId, pos_Ab_DQA)
  %>% distinct(SampleId, pos_Ab_DQA, .keep_all = TRUE)
#Clean up specificities
#This adds a colon to allele-specific antibodies that don't have a colon
  %>% mutate(pos_Ab_DQA = case_when(str_detect(pos_Ab_DQA, "[:digit:]{4}") ~ stri_sub_replace(pos_Ab_DQA, 3,2, value = ":"), TRUE ~ as.character(pos_Ab_DQA)))
#Add an "DQA1*" to low-res specificities, and "DQA1*" to allelic specificities
  %>% mutate(pos_Ab_DQA = case_when(
    str_detect(pos_Ab_DQA, ":", negate = TRUE) ~ str_replace(pos_Ab_DQA, "^", "DQA1*"),
    str_detect(pos_Ab_DQA, ":") ~ str_replace(pos_Ab_DQA, "^", "DQA1*")
    ))
#Collapse all specificities to a single row
  %>% group_by(SampleId)
  %>% summarize(pos_Ab_DQA = toString(pos_Ab_DQA))
  %>% ungroup
#Add a comma to the end of the specificities.
  %>% mutate(pos_Ab_DQA = as.character(str_glue("{pos_Ab_DQA},")))
)

#DP
(Case_MM_SAB_tests_DP <- Case_MM_SAB_tests
#Separate each specificity into a new row
  %>% distinct(TestId, .keep_all = TRUE)
  %>% separate_rows(pos_Ab_DP, sep = " ")
  %>% mutate(pos_Ab_DP = str_replace_all(pos_Ab_DP, " ", ""))
  %>% filter(pos_Ab_DP != "")
  %>% select(SampleId, pos_Ab_DP)
  %>% distinct(SampleId, pos_Ab_DP, .keep_all = TRUE)
#Clean up specificities
#This adds a colon to allele-specific antibodies that don't have a colon
  %>% mutate(pos_Ab_DP = case_when(str_detect(pos_Ab_DP, "[:digit:]{4}") ~ stri_sub_replace(pos_Ab_DP, 3,2, value = ":"), TRUE ~ as.character(pos_Ab_DP)))
#Add an "DP" to serologic specificities, and "DPB1*" to allelic specificities
  %>% mutate(pos_Ab_DP = case_when(
    str_detect(pos_Ab_DP, ":", negate = TRUE) ~ str_replace(pos_Ab_DP, "^", "DP"),
    str_detect(pos_Ab_DP, ":") ~ str_replace(pos_Ab_DP, "^", "DPB1*")
    ))
#Collapse all specificities to a single row
  %>% group_by(SampleId)
  %>% summarize(pos_Ab_DP = toString(pos_Ab_DP))
  %>% ungroup
#Add a comma to the end of the specificities.
  %>% mutate(pos_Ab_DP = as.character(str_glue("{pos_Ab_DP},")))
)

#DPA
#Many DPA specificities are reported to just the first field, meaning they won't align properly to the typing on the beads, or on the donor. I think it will be best to create a one-field typing for the SAB beads and donor type.
(Case_MM_SAB_tests_DPA <- Case_MM_SAB_tests
#Separate each specificity into a new row
  %>% distinct(TestId, .keep_all = TRUE)
  %>% separate_rows(pos_Ab_DPA, sep = " ")
  %>% mutate(pos_Ab_DPA = str_replace_all(pos_Ab_DPA, " ", ""))
  %>% filter(pos_Ab_DPA != "")
  %>% select(SampleId, pos_Ab_DPA)
  %>% distinct(SampleId, pos_Ab_DPA, .keep_all = TRUE)
#Clean up specificities
#This adds a colon to allele-specific antibodies that don't have a colon
  %>% mutate(pos_Ab_DPA = case_when(str_detect(pos_Ab_DPA, "[:digit:]{4}") ~ stri_sub_replace(pos_Ab_DPA, 3,2, value = ":"), TRUE ~ as.character(pos_Ab_DPA)))
#Add a "DPA1*" to low-res specificities, and "DPA1*" to allelic specificities
  %>% mutate(pos_Ab_DPA = case_when(
    str_detect(pos_Ab_DPA, ":", negate = TRUE) ~ str_replace(pos_Ab_DPA, "^", "DPA1*"),
    str_detect(pos_Ab_DPA, ":") ~ str_replace(pos_Ab_DPA, "^", "DPA1*")
    ))
#Collapse all specificities to a single row
  %>% group_by(SampleId)
  %>% summarize(pos_Ab_DPA = toString(pos_Ab_DPA))
  %>% ungroup
#Add a comma to the end of the specificities.
  %>% mutate(pos_Ab_DPA = as.character(str_glue("{pos_Ab_DPA},")))
)

#Filter the master table for CII results and join to tables made in this chunk.
(Case_MM_SAB_tests_C2 <- Case_MM_SAB_tests
  %>% filter(TestMethodCd == "Class II SAB")
  %>% left_join(Case_MM_SAB_tests_DR, by = "SampleId", suffix = c("_raw", "_clean"))
  %>% left_join(Case_MM_SAB_tests_DR5X, by = "SampleId", suffix = c("_raw", "_clean"))
  %>% left_join(Case_MM_SAB_tests_DQ, by = "SampleId", suffix = c("_raw", "_clean"))
  %>% left_join(Case_MM_SAB_tests_DQA, by = "SampleId", suffix = c("_raw", "_clean"))
  %>% left_join(Case_MM_SAB_tests_DP, by = "SampleId", suffix = c("_raw", "_clean"))
  %>% left_join(Case_MM_SAB_tests_DPA, by = "SampleId", suffix = c("_raw", "_clean"))
#Join all to a single class II positive column.
  %>% mutate(pos_Ab_C2 = str_glue("{pos_Ab_DR_clean} {pos_Ab_DR5X_clean} {pos_Ab_DQ_clean} {pos_Ab_DQA_clean} {pos_Ab_DP_clean} {pos_Ab_DPA_clean}"))
  %>% mutate(pos_Ab_C2 = str_replace_all(pos_Ab_C2, "NA", ""))
  %>% mutate(pos_Ab_C2 = str_trim(pos_Ab_C2))
  %>% mutate(pos_Ab_C2 = na_if(pos_Ab_C2, ""))
#Select only the sample number and the CII results
  %>% select(SampleNbr, pos_Ab_C2)
  %>% mutate(pos_Ab_C2 = replace_na(pos_Ab_C2, "negative"))
  %>% mutate(TestMethodCd = "Class II SAB")
)

```

```{r include=FALSE}
#Assign each bead as positive or negative based on manual results.

#First separate the SAB results into class I and class II.
(Case_C1 <- Case_MM_SAB_tests %>% filter(TestMethodCd == "Class I SAB"))

(Case_C2 <- Case_MM_SAB_tests %>% filter(TestMethodCd == "Class II SAB"))

#Join results to bead values.

#Class I
(Case_bead_results_C1 <- Case_C1
 %>% left_join(Case_MM_SAB_tests_C1, by = "SampleNbr")
 #Add a comma to the ends of serologic and allelic values so it will properly match up with the results.
 %>% mutate(SAB_sero_spec = str_glue("{SAB_sero_spec},"))
 %>% mutate(SingleAgSpecificity.A = str_glue("{SingleAgSpecificity.A},"))
 #Record each bead as pos or neg
 %>% mutate(bead_result_sero = str_detect(pos_Ab_C1, SAB_sero_spec))
 %>% mutate(bead_result_Bw4_w6 = str_detect(pos_Ab_C1, SAB_Bw4Bw6_spec))
 %>% mutate(bead_result_allele = str_detect(pos_Ab_C1, SingleAgSpecificity.A))
 %>% mutate(bead_result = case_when(
    bead_result_sero == TRUE | bead_result_Bw4_w6 == TRUE | bead_result_allele == TRUE ~ "positive",
    TRUE ~ "negative"
    )
  )
 %>% distinct()
 %>% mutate(SAB_sero_spec = str_replace(SAB_sero_spec, ",", ""))
 %>% mutate(SingleAgSpecificity.A = str_replace(SingleAgSpecificity.A, ",", ""))
 )

#Class II
(Case_bead_results_C2 <- Case_C2
 %>% left_join(Case_MM_SAB_tests_C2, by = "SampleNbr")
  #Add a comma to the ends of serologic and allelic values so it will properly match up with the results.
 %>% mutate(SAB_sero_spec = str_glue("{SAB_sero_spec},"))
 %>% mutate(SingleAgSpecificity.A = str_glue("{SingleAgSpecificity.A},"))
 %>% mutate(SingleAgSpecificity.B = str_glue("{SingleAgSpecificity.B},"))
 %>% mutate(DPA_DQA_LR_specificity = str_glue("{DPA_DQA_LR_specificity},"))
 #Record each bead as pos or neg 
 %>% mutate(bead_result_sero = str_detect(pos_Ab_C2, SAB_sero_spec))
 %>% mutate(bead_result_alpha = str_detect(pos_Ab_C2, SingleAgSpecificity.A))
 %>% mutate(bead_result_beta = str_detect(pos_Ab_C2, SingleAgSpecificity.B))
 %>% mutate(bead_result_alpha_LR = str_detect(pos_Ab_C2, DPA_DQA_LR_specificity))
 %>% mutate(bead_result = case_when(
    bead_result_sero == TRUE | bead_result_alpha == TRUE | bead_result_beta == TRUE | bead_result_alpha_LR == TRUE ~ "positive",
    TRUE ~ "negative"
    )
  )
 %>% distinct()
 %>% mutate(SAB_sero_spec = str_replace(SAB_sero_spec, ",", ""))
 %>% mutate(SingleAgSpecificity.A = str_replace(SingleAgSpecificity.A, ",", ""))
 %>% mutate(SingleAgSpecificity.B = str_replace(SingleAgSpecificity.B, ",", ""))
 %>% mutate(DPA_DQA_LR_specificity = str_replace(DPA_DQA_LR_specificity, ",", ""))
 )

#Combine CI and CII tables
(case_table_bead_results <- bind_rows(Case_bead_results_C1, Case_bead_results_C2)
  %>% arrange(SampleDt)
)
```

```{r eval=FALSE, include=FALSE}
#Test code, not used in production.
#Join SAB results to recipient/donor table by HvG mismatch (high resolution).
(A_1_DSAs_HR <- Case_MM 
   %>% inner_join(select(Case_MM_SAB_tests, SampleId:DPA_DQA_LR_specificity), by = c("A1Cd.donor" = "SingleAgSpecificity.A"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ A1Cd.donor), .after = SingleAgNormalized)
   )

(A_2_DSAs_HR <- Case_MM 
   %>% inner_join(select(Case_MM_SAB_tests, SampleId:DPA_DQA_LR_specificity), by = c("A.2.HvG" = "SingleAgSpecificity.A"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ A.2.HvG), .after = SingleAgNormalized)
   )

(B_1_DSAs_HR <- Case_MM 
   %>% inner_join(select(Case_MM_SAB_tests, SampleId:DPA_DQA_LR_specificity), by = c("B.1.HvG" = "SingleAgSpecificity.A"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ B.1.HvG), .after = SingleAgNormalized)
   )

(B_2_DSAs_HR <- Case_MM 
   %>% inner_join(select(Case_MM_SAB_tests, SampleId:DPA_DQA_LR_specificity), by = c("B.2.HvG" = "SingleAgSpecificity.A"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ B.2.HvG), .after = SingleAgNormalized)
   )

(C_1_DSAs_HR <- Case_MM 
   %>% inner_join(select(Case_MM_SAB_tests, SampleId:DPA_DQA_LR_specificity), by = c("C.1.HvG" = "SingleAgSpecificity.A"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ C.1.HvG), .after = SingleAgNormalized)
   )

(C_2_DSAs_HR <- Case_MM 
   %>% inner_join(select(Case_MM_SAB_tests, SampleId:DPA_DQA_LR_specificity), by = c("C.2.HvG" = "SingleAgSpecificity.A"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ C.2.HvG), .after = SingleAgNormalized)
   )

(DRB1_1_DSAs_HR <- Case_MM 
   %>% inner_join(select(Case_MM_SAB_tests, SampleId:DPA_DQA_LR_specificity), by = c("DRB1.1.HvG" = "SingleAgSpecificity.A"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ DRB1.1.HvG), .after = SingleAgNormalized)
   )

(DRB1_2_DSAs_HR <- Case_MM 
   %>% inner_join(select(Case_MM_SAB_tests, SampleId:DPA_DQA_LR_specificity), by = c("DRB1.2.HvG" = "SingleAgSpecificity.A"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ DRB1.2.HvG), .after = SingleAgNormalized)
   )

(DRB3_1_DSAs_HR <- Case_MM 
   %>% inner_join(select(Case_MM_SAB_tests, SampleId:DPA_DQA_LR_specificity), by = c("DRB3.1.HvG" = "SingleAgSpecificity.A"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ DRB3.1.HvG), .after = SingleAgNormalized)
   )

(DRB3_2_DSAs_HR <- Case_MM 
   %>% inner_join(select(Case_MM_SAB_tests, SampleId:DPA_DQA_LR_specificity), by = c("DRB3.2.HvG" = "SingleAgSpecificity.A"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ DRB3.2.HvG), .after = SingleAgNormalized)
   )

(DRB4_1_DSAs_HR <- Case_MM 
   %>% inner_join(select(Case_MM_SAB_tests, SampleId:DPA_DQA_LR_specificity), by = c("DRB4.1.HvG" = "SingleAgSpecificity.A"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ DRB4.1.HvG), .after = SingleAgNormalized)
   )

(DRB4_2_DSAs_HR <- Case_MM 
   %>% inner_join(select(Case_MM_SAB_tests, SampleId:DPA_DQA_LR_specificity), by = c("DRB4.2.HvG" = "SingleAgSpecificity.A"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ DRB4.2.HvG), .after = SingleAgNormalized)
   )

(DRB5_1_DSAs_HR <- Case_MM 
   %>% inner_join(select(Case_MM_SAB_tests, SampleId:DPA_DQA_LR_specificity), by = c("DRB5.1.HvG" = "SingleAgSpecificity.A"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ DRB5.1.HvG), .after = SingleAgNormalized)
   )

(DRB5_2_DSAs_HR <- Case_MM 
   %>% inner_join(select(Case_MM_SAB_tests, SampleId:DPA_DQA_LR_specificity), by = c("DRB5.2.HvG" = "SingleAgSpecificity.A"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ DRB5.2.HvG), .after = SingleAgNormalized)
   )

(DQB1_1_DSAs_HR <- Case_MM 
   %>% inner_join(select(Case_MM_SAB_tests, SampleId:DPA_DQA_LR_specificity), by = c("DQB1.1.HvG" = "SingleAgSpecificity.B"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ DQB1.1.HvG), .after = SingleAgNormalized)
   )

(DQB1_2_DSAs_HR <- Case_MM 
   %>% inner_join(select(Case_MM_SAB_tests, SampleId:DPA_DQA_LR_specificity), by = c("DQB1.2.HvG" = "SingleAgSpecificity.B"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ DQB1.2.HvG), .after = SingleAgNormalized)
   )

(DPB1_1_DSAs_HR <- Case_MM 
   %>% inner_join(select(Case_MM_SAB_tests, SampleId:DPA_DQA_LR_specificity), by = c("DPB1.1.HvG" = "SingleAgSpecificity.B"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ DPB1.1.HvG), .after = SingleAgNormalized)
   )

(DPB1_2_DSAs_HR <- Case_MM 
   %>% inner_join(select(Case_MM_SAB_tests, SampleId:DPA_DQA_LR_specificity), by = c("DPB1.2.HvG" = "SingleAgSpecificity.B"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ DPB1.2.HvG), .after = SingleAgNormalized)
   )

#Join all the tables into one
(Patient_DSAs_HR <- bind_rows(A_1_DSAs_HR, A_2_DSAs_HR, B_1_DSAs_HR, B_2_DSAs_HR, C_1_DSAs_HR, C_2_DSAs_HR, DRB1_1_DSAs_HR, DRB1_2_DSAs_HR, DRB3_1_DSAs_HR, DRB3_2_DSAs_HR, DRB4_1_DSAs_HR, DRB4_2_DSAs_HR, DRB5_1_DSAs_HR, DRB5_2_DSAs_HR, DQB1_1_DSAs_HR, DQB1_2_DSAs_HR, DPB1_1_DSAs_HR, DPB1_2_DSAs_HR)
    )
```

```{r include=FALSE}
#Join SAB results to recipient/donor table by donor typing (low resolution).
(A_1_DSAs_LR <- Case_MM 
   %>% inner_join(select(case_table_bead_results, SampleId:DPA_DQA_LR_specificity, bead_result), by = c("A1Cd.donor" = "SAB_sero_spec"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ A1Cd.donor), .after = DP.2.mismatch)
   )

(A_2_DSAs_LR <- Case_MM 
   %>% inner_join(select(case_table_bead_results, SampleId:DPA_DQA_LR_specificity, bead_result), by = c("A2Cd.donor" = "SAB_sero_spec"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ A2Cd.donor), .after = DP.2.mismatch)
   )

(B_1_DSAs_LR <- Case_MM 
   %>% inner_join(select(case_table_bead_results, SampleId:DPA_DQA_LR_specificity, bead_result), by = c("B1Cd.donor" = "SAB_sero_spec"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ B1Cd.donor), .after = DP.2.mismatch)
   )

(B_2_DSAs_LR <- Case_MM 
   %>% inner_join(select(case_table_bead_results, SampleId:DPA_DQA_LR_specificity, bead_result), by = c("B2Cd.donor" = "SAB_sero_spec"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ B2Cd.donor), .after = DP.2.mismatch)
   )

(C_1_DSAs_LR <- Case_MM 
   %>% inner_join(select(case_table_bead_results, SampleId:DPA_DQA_LR_specificity, bead_result), by = c("Cw1Cd.donor" = "SAB_sero_spec"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ Cw1Cd.donor), .after = DP.2.mismatch)
   )

(C_2_DSAs_LR <- Case_MM 
   %>% inner_join(select(case_table_bead_results, SampleId:DPA_DQA_LR_specificity, bead_result), by = c("Cw2Cd.donor" = "SAB_sero_spec"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ Cw2Cd.donor), .after = DP.2.mismatch)
   )

(DR_1_DSAs_LR <- Case_MM 
   %>% inner_join(select(case_table_bead_results, SampleId:DPA_DQA_LR_specificity, bead_result), by = c("DR1Cd.donor" = "SAB_sero_spec"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ DR1Cd.donor), .after = DP.2.mismatch)
   )

(DR_2_DSAs_LR <- Case_MM 
   %>% inner_join(select(case_table_bead_results, SampleId:DPA_DQA_LR_specificity, bead_result), by = c("DR2Cd.donor" = "SAB_sero_spec"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ DR2Cd.donor), .after = DP.2.mismatch)
   )

(DR51_52_53_1_DSAs_LR <- Case_MM 
   %>% inner_join(select(case_table_bead_results, SampleId:DPA_DQA_LR_specificity, bead_result), by = c("drw1cd.donor" = "SAB_sero_spec"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ drw1cd.donor), .after = DP.2.mismatch)
   )

(DR51_52_53_2_DSAs_LR <- Case_MM 
   %>% inner_join(select(case_table_bead_results, SampleId:DPA_DQA_LR_specificity, bead_result), by = c("drw2cd.donor" = "SAB_sero_spec"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ drw2cd.donor), .after = DP.2.mismatch)
   )

(DQ_1_DSAs_LR <- Case_MM 
   %>% inner_join(select(case_table_bead_results, SampleId:DPA_DQA_LR_specificity, bead_result), by = c("dq1cd.donor" = "SAB_sero_spec"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ dq1cd.donor), .after = DP.2.mismatch)
   )

(DQ_2_DSAs_LR <- Case_MM 
   %>% inner_join(select(case_table_bead_results, SampleId:DPA_DQA_LR_specificity, bead_result), by = c("dq2cd.donor" = "SAB_sero_spec"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ dq2cd.donor), .after = DP.2.mismatch)
   )



(DQA_1_DSAs_LR <- Case_MM 
   %>% inner_join(select(case_table_bead_results, SampleId:DPA_DQA_LR_specificity, bead_result), by = c("mDQA11Cd.donor" = "DPA_DQA_LR_specificity"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ mDQA11Cd.donor), .after = DP.2.mismatch)
   )

(DQA_2_DSAs_LR <- Case_MM 
   %>% inner_join(select(case_table_bead_results, SampleId:DPA_DQA_LR_specificity, bead_result), by = c("mDQA12Cd.donor" = "DPA_DQA_LR_specificity"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ mDQA12Cd.donor), .after = DP.2.mismatch)
   )


(DPA_1_DSAs_LR <- Case_MM 
   %>% inner_join(select(case_table_bead_results, SampleId:DPA_DQA_LR_specificity, bead_result), by = c("mDPA11Cd.donor" = "DPA_DQA_LR_specificity"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ mDPA11Cd.donor), .after = DP.2.mismatch)
   )

(DPA_2_DSAs_LR <- Case_MM 
   %>% inner_join(select(case_table_bead_results, SampleId:DPA_DQA_LR_specificity, bead_result), by = c("mDPA12Cd.donor" = "DPA_DQA_LR_specificity"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ mDPA12Cd.donor), .after = DP.2.mismatch)
   )


(DP_1_DSAs_LR <- Case_MM 
   %>% inner_join(select(case_table_bead_results, SampleId:DPA_DQA_LR_specificity, bead_result), by = c("DP1Cd.donor" = "SAB_sero_spec"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ DP1Cd.donor), .after = DP.2.mismatch)
   )

(DP_2_DSAs_LR <- Case_MM 
   %>% inner_join(select(case_table_bead_results, SampleId:DPA_DQA_LR_specificity, bead_result), by = c("DP2Cd.donor" = "SAB_sero_spec"))
   %>% mutate(DSA = case_when(!is.na(SingleAgNormalized) ~ DP2Cd.donor), .after = DP.2.mismatch)
   )

#Join all the tables into one
(Patient_DSAs_LR <- bind_rows(A_1_DSAs_LR, A_2_DSAs_LR, B_1_DSAs_LR, B_2_DSAs_LR, C_1_DSAs_LR, C_2_DSAs_LR, DR_1_DSAs_LR, DR_2_DSAs_LR, DR51_52_53_1_DSAs_LR, DR51_52_53_2_DSAs_LR, DQ_1_DSAs_LR, DQ_2_DSAs_LR, DP_1_DSAs_LR, DP_2_DSAs_LR, DQA_1_DSAs_LR, DQA_2_DSAs_LR, DPA_1_DSAs_LR, DPA_2_DSAs_LR)
    )
```

```{r eval=FALSE, include=FALSE}
#Test code, not used in production.
(HR_DSA_table <- Patient_DSAs_HR 
  %>% select(SampleDt, SampleNbr, DSA, SingleAgNormalized)
  %>% distinct(.keep_all = TRUE)
  %>% arrange(DSA, SampleDt)
)
```

```{r include=FALSE}
#Make tables for report

#Table of DSAs by bead for graphing.
(LR_DSA_graph <- Patient_DSAs_LR 
  %>% select(SampleDt, SampleNbr, DSA, SingleAgSpecificity.A, SingleAgSpecificity.B, SingleAgNormalized, bead_result)
  %>% distinct(.keep_all = TRUE)
  %>% arrange(DSA, SampleDt)
  %>% mutate(SingleAgSpecificity.B = str_replace(SingleAgSpecificity.B, "blank", ""))
  #%>% mutate(bead_result = cell_spec(bead_result, "latex", background = ifelse(bead_result == "positive", "orange", "white")))
  #%>% mutate(SingleAgNormalized = cell_spec(SingleAgNormalized, "latex", background = ifelse(SingleAgNormalized > 1000, "yellow", "white")))
    )

#Table of DSAs by bead for table.
(LR_DSA_table <- Patient_DSAs_LR 
  %>% select(SampleDt, SampleNbr, DSA, SingleAgSpecificity.A, SingleAgSpecificity.B, SingleAgNormalized, bead_result)
  %>% distinct(.keep_all = TRUE)
  %>% arrange(DSA, SampleDt)
  %>% mutate(SingleAgSpecificity.B = str_replace(SingleAgSpecificity.B, "blank", ""))
  %>% mutate(bead_result = cell_spec(bead_result, "latex", background = ifelse(bead_result == "positive", "orange", "white")))
  %>% mutate(SingleAgNormalized = cell_spec(SingleAgNormalized, "latex", background = ifelse(SingleAgNormalized >= 1000, "yellow", "white")))
    )

#Current sample
(Current_sample <- LR_DSA_table
  %>% mutate(Sample_age = floor(difftime(Sys.time(), SampleDt, units = "days")))
  %>% arrange(Sample_age)
  %>% slice_head()
  %>% select(SampleDt, Sample_age)
  )
```

```{r include=FALSE}
#Create recipient and donor typing and mismatch table

#Recipeint typing
(Recipient_typing <- Case 
  %>% select(A1Cd.recipient:dq2cd.recipient, mDQA11Cd.recipient, mDQA12Cd.recipient, mDPB11cd.recipient, mDPB12cd.recipient, mDPA11Cd.recipient, mDPA12Cd.recipient)
    )

(Recipient_typing_1 <- Recipient_typing
  %>% select(!contains("2"))
  %>% rename(A = A1Cd.recipient)
  %>% rename(B = B1Cd.recipient)
  %>% rename(Bw = BW1Cd.recipient)
  %>% rename(Cw = Cw1Cd.recipient)
  %>% rename(DR = DR1Cd.recipient)
  %>% rename(DR5X = drw1cd.recipient)
  %>% rename(DQ = dq1cd.recipient)
  %>% rename(DQA1 = mDQA11Cd.recipient)
  %>% rename(DPB1 = mDPB11cd.recipient)
  %>% rename(DPA1 = mDPA11Cd.recipient)
  )

(Recipient_typing_2 <- Recipient_typing
  %>% select(contains("2"))
  %>% rename(A = A2Cd.recipient)
  %>% rename(B = B2Cd.recipient)
  %>% rename(Bw = Bw2Cd.recipient)
  %>% rename(Cw = Cw2Cd.recipient)
  %>% rename(DR = DR2Cd.recipient)
  %>% rename(DR5X = drw2cd.recipient)
  %>% rename(DQ = dq2cd.recipient)
  %>% rename(DQA1 = mDQA12Cd.recipient)
  %>% rename(DPB1 = mDPB12cd.recipient)
  %>% rename(DPA1 = mDPA12Cd.recipient)
  )

(Recipient_typing_report <- bind_rows(Recipient_typing_1, Recipient_typing_2)
  %>% mutate(Case = "Recipient", .before = A)
    )

#Recording (or overwriting) new values in the data frame - this is used to delete "Recipient" on the second row, to make the table look nicer, and then to add a new, blank row so that there will be a space between recipient and donor typing when they are joined below.
#data.frame[row_number, column_number] = new_value
Recipient_typing_report[2, 1] = ""
#Recipient_typing_report[3, 1] = ""

print(Recipient_typing_report)

#Donor typing
(Donor_typing <- Case 
  %>% select(A1Cd.donor:dq2cd.donor, mDQA11Cd.donor, mDQA12Cd.donor, mDPB11cd.donor, mDPB12cd.donor, mDPA11Cd.donor, mDPA12Cd.donor)
    )

#Make a URL for HaploStats for the donor.
(haplostats <- Donor_typing
  %>% mutate(across(everything(), ~ifelse(is.na(.), "", as.character(.))))
  %>% mutate(url = str_glue(
    "http://haplostats.org/haplostats?dataset=NMDP%20full%202011&populations=AFA,API,CAU,HIS,NAM&loci=A~C~B~DRBX~DRB1~DQB1",
    "&a1={A1Cd.donor}",
    "&a2={A2Cd.donor}",
    "&b1={B1Cd.donor}",
    "&b2={B2Cd.donor}",
    "&c1={Cw1Cd.donor}",
    "&c2={Cw2Cd.donor}",
    "&drb11={DR1Cd.donor}",
    "&drb12={DR2Cd.donor}",
    "&dqb11={dq1cd.donor}",
    "&dqb12={dq2cd.donor}"))
  )

(Donor_typing_1 <- Donor_typing
  %>% select(!contains("2"))
  %>% rename(A = A1Cd.donor)
  %>% rename(B = B1Cd.donor)
  %>% rename(Bw = BW1Cd.donor)
  %>% rename(Cw = Cw1Cd.donor)
  %>% rename(DR = DR1Cd.donor)
  %>% rename(DR5X = drw1cd.donor)
  %>% rename(DQ = dq1cd.donor)
  %>% rename(DQA1 = mDQA11Cd.donor)
  %>% rename(DPB1 = mDPB11cd.donor)
  %>% rename(DPA1 = mDPA11Cd.donor)
  )

(Donor_typing_2 <- Donor_typing
  %>% select(contains("2"))
  %>% rename(A = A2Cd.donor)
  %>% rename(B = B2Cd.donor)
  %>% rename(Bw = Bw2Cd.donor)
  %>% rename(Cw = Cw2Cd.donor)
  %>% rename(DR = DR2Cd.donor)
  %>% rename(DR5X = drw2cd.donor)
  %>% rename(DQ = dq2cd.donor)
  %>% rename(DQA1 = mDQA12Cd.donor)
  %>% rename(DPB1 = mDPB12cd.donor)
  %>% rename(DPA1 = mDPA12Cd.donor)
  )

(Donor_typing_report <- bind_rows(Donor_typing_1,Donor_typing_2)
  %>% mutate(Case = "Donor", .before = A)
    )

#data.frame[row_number, column_number] = new_value
Donor_typing_report[2, 1] = ""
#Donor_typing_report[3, 1] = ""

print(Donor_typing_report)

#Calculate MM numbers to go below recipient and donor typing. 
(MM_by_locus <- Case_MM 
  %>% mutate(A = as.character(as.integer(!is.na(A.1.mismatch)) + as.integer(!is.na(A.2.mismatch))))
  %>% mutate(B = as.character(as.integer(!is.na(B.1.mismatch)) + as.integer(!is.na(B.2.mismatch))))
  %>% mutate(Bw = as.character(as.integer(!is.na(Bw.1.mismatch)) + as.integer(!is.na(Bw.2.mismatch))))
  %>% mutate(Cw = as.character(as.integer(!is.na(Cw.1.mismatch)) + as.integer(!is.na(Cw.2.mismatch))))
  %>% mutate(DR = as.character(as.integer(!is.na(DR.1.mismatch)) + as.integer(!is.na(DR.2.mismatch))))
  %>% mutate(DR5X = as.character(as.integer(!is.na(DR.51.52.53.1.mismatch)) + as.integer(!is.na(DR.51.52.53.2.mismatch))))
  %>% mutate(DQ = as.character(as.integer(!is.na(DQ.1.mismatch)) + as.integer(!is.na(DQ.2.mismatch))))
  %>% mutate(DQA1 = as.character((!is.na(DQA.1.mismatch)) + as.integer(!is.na(DQA.2.mismatch))))
  %>% mutate(DPB1 = as.character(as.integer(!is.na(DPB1.1.HvG)) + as.integer(!is.na(DPB1.2.HvG))))
  %>% mutate(DPA1 = as.character((!is.na(DPA.1.mismatch)) + as.integer(!is.na(DPA.2.mismatch))))
  %>% select(A, B, Bw, Cw, DR, DR5X, DQ, DQA1, DPB1, DPA1) 
  %>% mutate(Case = "Mismatches", .before = A)
)


#Format the final table and clean it up.
(total_typing_report <- bind_rows(Recipient_typing_report, Donor_typing_report, MM_by_locus)
  %>% mutate(across(everything(), ~replace_na(.x, "")))
    )
```

```{r include=FALSE}
#Extract low res mismatches for printing on report
(LR_MM <- Case_MM 
  %>% select(A.1.mismatch:DQA.2.mismatch, DPB1.1.HvG:DPB1.2.HvG, DPA.1.mismatch:DPA.2.mismatch)
  #The asterisk in "DQA1*," etc. was causing the text on the report to be italicized. This code inserts "\\" before the asterisk to escape this character, so the text shows up properly on the report.
  %>% mutate(DQA.1.mismatch = str_extract(DQA.1.mismatch, "(?<=[:punct:])[:graph:]+"))
  %>% mutate(DQA.1.mismatch = case_when(!is.na(DQA.1.mismatch) ~ str_glue("DQA1\\*{DQA.1.mismatch}")))
  %>% mutate(DQA.2.mismatch = str_extract(DQA.2.mismatch, "(?<=[:punct:])[:graph:]+"))
  %>% mutate(DQA.2.mismatch = case_when(!is.na(DQA.2.mismatch) ~ str_glue("DQA1\\*{DQA.2.mismatch}"))) 
 
  %>% mutate(DPB1.1.HvG = str_extract(DPB1.1.HvG, "(?<=[:punct:])[:graph:]+"))
  %>% mutate(DPB1.1.HvG = case_when(!is.na(DPB1.1.HvG) ~ str_glue("DPB1\\*{DPB1.1.HvG}")))
  %>% mutate(DPB1.2.HvG = str_extract(DPB1.2.HvG, "(?<=[:punct:])[:graph:]+"))
  %>% mutate(DPB1.2.HvG = case_when(!is.na(DPB1.2.HvG) ~ str_glue("DPB1\\*{DPB1.2.HvG}")))
 
  %>% mutate(DPA.1.mismatch = str_extract(DPA.1.mismatch, "(?<=[:punct:])[:graph:]+"))
  %>% mutate(DPA.1.mismatch = case_when(!is.na(DPA.1.mismatch) ~ str_glue("DPA1\\*{DPA.1.mismatch}")))
  %>% mutate(DPA.2.mismatch = str_extract(DPA.2.mismatch, "(?<=[:punct:])[:graph:]+"))
  %>% mutate(DPA.2.mismatch = case_when(!is.na(DPA.2.mismatch) ~ str_glue("DPA1\\*{DPA.2.mismatch}")))
  )

(LR_MM_vector <- as.character(as.vector(LR_MM[1,])))

(LR_MM_vector_clean <- na.omit(LR_MM_vector))
```
**Patient:** `r Case$lastnm.recipient`, `r Case$firstnm.recipient`  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  **MRN:** `r Case$HospitalID.recipient`  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  **ABO:** `r Case$ABOCd.recipient`  
**Donor:** `r Case$firstnm.donor` &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  **DOB:** `r Case$DOB.donor` &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  **ABO:** `r Case$ABOCd.donor`  
**Organ type:** `r Case$categoryCd.recipient` &nbsp;  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  **UNOS CPRA:** `r Case$UNOSCPRAAmt.recipient`%  
```{r echo=FALSE}
#Table of typing
kbl(total_typing_report, booktabs = TRUE, , caption = "Typing", col.names = c('', 'A', 'B', 'Bw', 'Cw', 'DR', 'DR5X', 'DQ', 'DQA1*', 'DPB1*', 'DPA1*')) %>% kable_styling(full_width = T) %>% column_spec(1, width = "2cm") %>% row_spec(2, hline_after = TRUE) %>% row_spec(4, hline_after = TRUE) %>% kable_styling(latex_options = "hold_position")

```  
**Mismatched donor antigens:** `r LR_MM_vector_clean`   

**A,B,DR,DQ summary matching:** `r MM_by_locus$A`A, `r MM_by_locus$B`B, `r MM_by_locus$DR`DR, `r MM_by_locus$DQ`DQ mismatch  

**Impute high resolution A, B, C, DRB1, DRB3/4/5, and DQB1 donor typing:** [HaploStats](`r haplostats$url`)  
&nbsp;  
&nbsp;  
```{r echo=FALSE}
#Table of special crossmatch considerations
kbl(Notes, booktabs = TRUE, col.names = 'Special XM considerations') %>% kable_styling(full_width = T) %>% kable_styling(latex_options = "hold_position")
```
&nbsp;  
```{r echo=FALSE}
#Table of sensitizing events
kbl(TransplantHistory, booktabs = TRUE, caption = "Sensitizing events", col.names = c('Date', 'Event', 'Notes')) %>% kable_styling(full_width = T) %>%
column_spec(1, width = "2cm") %>%
column_spec(2, width = "2cm") %>% kable_styling(latex_options = "hold_position")
```


\newpage

# Antibody data
**Most recently-tested antibody sample:** `r month(Current_sample$SampleDt)`/`r day(Current_sample$SampleDt)`/`r year(Current_sample$SampleDt)`  
**Sample age:** `r Current_sample$Sample_age` days  
&nbsp;  
  


```{r, echo=FALSE}
#Graph LR DSAs
ggplot(LR_DSA_graph, aes(x = SampleDt, y = SingleAgNormalized, color = DSA)) + geom_point() +stat_summary(aes(y = SingleAgNormalized), fun=mean, geom="line") +geom_hline(yintercept = 1000) +labs(x = "Sample date", y = "MFI", title = "Low-resolution DSAs") +theme_bw()
```

```{r echo=FALSE}
#Table of LR DSAs
kbl(LR_DSA_table, longtable = TRUE, booktabs = TRUE, escape = FALSE, linesep = "", caption = "Low-resolution DSA specificities", col.names = c('Date', 'Sample', 'Serology', 'Bead', '', 'MFI', 'result')) %>% kable_styling(latex_options = ("repeat_header")) 

```
